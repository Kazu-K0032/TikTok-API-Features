{% extends "base.html" %} {% block title %}ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰{% endblock %} {% block
extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/dashboard.css') }}"
/>
{% endblock %} {% block content %}
<div id="dashboard-content">
  <h1>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h1>
  <div class="card">
    <div class="profile-container">
      <div>
        <img
          src="{{ profile.avatar_url or '' }}"
          alt="ã‚¢ãƒã‚¿ãƒ¼"
          class="profile-avatar"
          loading="lazy"
          onerror="this.style.display='none'"
          id="profile-avatar"
        />
      </div>
      <div>
        <h2 class="profile-name" id="profile-name">
          {{ profile.display_name or 'æœªè¨­å®š' }}
        </h2>
        {% if profile.username %}
        <p class="profile-username" id="profile-username">
          <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</strong> @{{ profile.username }}
        </p>
        {% endif %}
        <p class="profile-openid">
          Open ID:
          <code id="profile-openid">{{ profile.open_id or 'æœªå–å¾—' }}</code>
        </p>
        {% if profile.bio_description %}
        <p class="profile-bio" id="profile-bio">
          <strong>è‡ªå·±ç´¹ä»‹:</strong> {{ profile.bio_description }}
        </p>
        {% endif %} {% if profile.is_verified %}
        <p class="profile-verified" id="profile-verified">
          âœ“ èªè¨¼æ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
        </p>
        {% endif %} {% if profile.profile_web_link %}
        <p class="profile-link" id="profile-link">
          <a href="{{ profile.profile_web_link }}" target="_blank">
            ğŸŒ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã‚’é–‹ã
          </a>
        </p>
        {% endif %}
      </div>
    </div>
  </div>

  <h2>çµ±è¨ˆæƒ…å ±</h2>
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-number" id="following-count">
        {{ profile.following_count }}
      </div>
      <div class="stat-label">ãƒ•ã‚©ãƒ­ãƒ¼æ•°</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="follower-count">
        {{ profile.follower_count }}
      </div>
      <div class="stat-label">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼æ•°</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="likes-count">{{ profile.likes_count }}</div>
      <div class="stat-label">ã„ã„ã­æ•°</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="video-count">{{ profile.video_count }}</div>
      <div class="stat-label">å‹•ç”»æ•°</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="share-count">{{ total_share_count }}</div>
      <div class="stat-label">ç·ã‚·ã‚§ã‚¢æ•°</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="avg-engagement-rate">
        {{ avg_engagement_rate }}%
      </div>
      <div class="stat-label">å¹³å‡ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ</div>
    </div>
  </div>
  <p>
    <small
      >â€» çµ±è¨ˆæƒ…å ±ãŒ0ã®å ´åˆã¯ã€user.info.stats
      ã‚¹ã‚³ãƒ¼ãƒ—ã®èªè¨¼ãŒå¿…è¦ã‹ã€å®Ÿéš›ã®å€¤ãŒ0ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</small
    >
  </p>

  <h2>æŠ•ç¨¿å‹•ç”»ä¸€è¦§</h2>
  <div class="dashboard-actions">
    <a href="{{ url_for('video_upload') }}" class="btn btn-primary">
      <span class="btn-icon">ğŸ“¤</span>
      <span class="btn-text">å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
    </a>
  </div>
  <div id="videos-container">
    {% if videos %} {% if pagination_summary %}
    <div class="pagination-summary">
      <p>{{ pagination_summary }}</p>
    </div>
    {% endif %}

    <div class="video-grid" id="video-grid">
      {% for v in videos %}
      <div class="video-card">
        {% if v.best_image_url %}
        <div class="video-thumbnail">
          <img
            src="{{ v.best_image_url }}"
            alt="ã‚µãƒ ãƒã‚¤ãƒ«"
            class="video-cover"
            loading="lazy"
          />
        </div>
        {% endif %}
        <h3 class="video-title">{{ v.title or 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—' }}</h3>
        <div class="video-meta">
          <div class="video-id">
            <strong>ID:</strong> <code>{{ v.id }}</code>
          </div>
          <div class="video-date">
            <strong>æŠ•ç¨¿æ—¥:</strong> {{ v.formatted_create_time }}
          </div>
        </div>
        <div class="video-stats">
          <div>
            <div class="video-stat-number">{{ v.view_count or 0 }}</div>
            <div class="video-stat-label">å†ç”Ÿæ•°</div>
          </div>
          <div>
            <div class="video-stat-number">{{ v.like_count or 0 }}</div>
            <div class="video-stat-label">ã„ã„ã­</div>
          </div>
          <div>
            <div class="video-stat-number">{{ v.comment_count or 0 }}</div>
            <div class="video-stat-label">ã‚³ãƒ¡ãƒ³ãƒˆ</div>
          </div>
        </div>
        <a
          href="{{ url_for('video_detail', video_id=v.id) }}"
          class="btn btn-small"
          >è©³ç´°ã‚’è¦‹ã‚‹</a
        >
      </div>
      {% endfor %}
    </div>

    {% if pagination and pagination.total_pages > 1 %}
    <div class="pagination">
      {% if pagination.has_prev %}
      <a
        href="{{ url_for('dashboard', page=pagination.prev_page) }}"
        class="pagination-btn"
      >
        â† å‰ã®ãƒšãƒ¼ã‚¸
      </a>
      {% endif %}

      <div class="pagination-pages">
        {% for page_num in pagination.pages %} {% if page_num == pagination.page
        %}
        <span class="pagination-current">{{ page_num }}</span>
        {% else %}
        <a
          href="{{ url_for('dashboard', page=page_num) }}"
          class="pagination-link"
        >
          {{ page_num }}
        </a>
        {% endif %} {% endfor %}
      </div>

      {% if pagination.has_next %}
      <a
        href="{{ url_for('dashboard', page=pagination.next_page) }}"
        class="pagination-btn"
      >
        æ¬¡ã®ãƒšãƒ¼ã‚¸ â†’
      </a>
      {% endif %}
    </div>
    {% endif %} {% else %}
    <div class="card empty-state">
      <p class="empty-state-title">å‹•ç”»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>
      <p class="empty-state-description">
        â€» å…¬é–‹å‹•ç”»ãŒãªã„ã‹ã€å‹•ç”»ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
      </p>
    </div>
    {% endif %}
  </div>

  <a href="{{ url_for('index') }}" class="back-link">â† ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</a>
</div>

<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
<div id="loading-overlay" class="loading-overlay" style="display: none">
  <div class="loading-spinner">
    <div class="spinner"></div>
    <p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  // SPAé¢¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
  async function switchUser(openId) {
    try {
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      showLoading();

      const response = await fetch("/api/switch-user", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ open_id: openId }),
      });

      if (response.ok) {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const userDataResponse = await fetch(
          `/api/user-data?open_id=${openId}`
        );
        if (userDataResponse.ok) {
          const userData = await userDataResponse.json();
          updateDashboardContent(userData);
        } else {
          // ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ãŸå ´åˆã¯ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
          window.location.reload();
        }
      } else {
        const data = await response.json();
        alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ: " + data.error);
      }
    } catch (error) {
      console.error("ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:", error);
      alert("ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡ã‚Šæ›¿ãˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    } finally {
      hideLoading();
    }
  }

  // ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°
  function updateDashboardContent(userData) {
    const { profile, videos, user_info } = userData;

    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æƒ…å ±ã‚’æ›´æ–°
    if (profile) {
      // ã‚¢ãƒã‚¿ãƒ¼
      const avatar = document.getElementById("profile-avatar");
      if (avatar) {
        avatar.src = profile.avatar_url || "/static/images/default-avatar.svg";
      }

      // è¡¨ç¤ºå
      const name = document.getElementById("profile-name");
      if (name) {
        name.textContent = profile.display_name || "æœªè¨­å®š";
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼å
      const username = document.getElementById("profile-username");
      if (username) {
        if (profile.username) {
          username.innerHTML = `<strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</strong> @${profile.username}`;
          username.style.display = "block";
        } else {
          username.style.display = "none";
        }
      }

      // Open ID
      const openId = document.getElementById("profile-openid");
      if (openId) {
        openId.textContent = profile.open_id || "æœªå–å¾—";
      }

      // è‡ªå·±ç´¹ä»‹
      const bio = document.getElementById("profile-bio");
      if (bio) {
        if (profile.bio_description) {
          bio.innerHTML = `<strong>è‡ªå·±ç´¹ä»‹:</strong> ${profile.bio_description}`;
          bio.style.display = "block";
        } else {
          bio.style.display = "none";
        }
      }

      // èªè¨¼æ¸ˆã¿
      const verified = document.getElementById("profile-verified");
      if (verified) {
        verified.style.display = profile.is_verified ? "block" : "none";
      }

      // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒªãƒ³ã‚¯
      const link = document.getElementById("profile-link");
      if (link) {
        if (profile.profile_web_link) {
          link.innerHTML = `<a href="${profile.profile_web_link}" target="_blank">ğŸŒ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã‚’é–‹ã</a>`;
          link.style.display = "block";
        } else {
          link.style.display = "none";
        }
      }

      // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
      const followingCount = document.getElementById("following-count");
      if (followingCount) {
        followingCount.textContent = profile.following_count || 0;
      }

      const followerCount = document.getElementById("follower-count");
      if (followerCount) {
        followerCount.textContent = profile.follower_count || 0;
      }

      const likesCount = document.getElementById("likes-count");
      if (likesCount) {
        likesCount.textContent = profile.likes_count || 0;
      }

      const videoCount = document.getElementById("video-count");
      if (videoCount) {
        videoCount.textContent = profile.video_count || 0;
      }

      // æ–°ã—ã„çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
      const shareCount = document.getElementById("share-count");
      if (shareCount) {
        shareCount.textContent = user_info.total_share_count || 0;
      }

      const avgEngagementRate = document.getElementById("avg-engagement-rate");
      if (avgEngagementRate) {
        avgEngagementRate.textContent = user_info.avg_engagement_rate || 0;
      }
    }

    // å‹•ç”»ãƒªã‚¹ãƒˆã‚’æ›´æ–°
    if (videos) {
      updateVideoGrid(videos);
    }

    // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
    updateHeaderActiveState(user_info.open_id);
  }

  // å‹•ç”»ã‚°ãƒªãƒƒãƒ‰ã‚’æ›´æ–°
  function updateVideoGrid(videos) {
    const videoGrid = document.getElementById("video-grid");
    if (!videoGrid) return;

    if (videos.length === 0) {
      videoGrid.innerHTML = `
      <div class="card empty-state">
        <p class="empty-state-title">å‹•ç”»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>
        <p class="empty-state-description">
          â€» å…¬é–‹å‹•ç”»ãŒãªã„ã‹ã€å‹•ç”»ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
        </p>
      </div>
    `;
      return;
    }

    const videoCards = videos
      .map(
        (video) => `
    <div class="video-card">
      ${
        video.best_image_url
          ? `
        <div class="video-thumbnail">
          <img
            src="${video.best_image_url}"
            alt="ã‚µãƒ ãƒã‚¤ãƒ«"
            class="video-cover"
            loading="lazy"
          />
        </div>
      `
          : ""
      }
      <h3 class="video-title">${video.title || "ã‚¿ã‚¤ãƒˆãƒ«ãªã—"}</h3>
      <div class="video-meta">
        <div class="video-id"><strong>ID:</strong> <code>${
          video.id
        }</code></div>
        <div class="video-date">
          <strong>æŠ•ç¨¿æ—¥:</strong> ${video.formatted_create_time || "ä¸æ˜"}
        </div>
      </div>
      <div class="video-stats">
        <div>
          <div class="video-stat-number">${video.view_count || 0}</div>
          <div class="video-stat-label">å†ç”Ÿæ•°</div>
        </div>
        <div>
          <div class="video-stat-number">${video.like_count || 0}</div>
          <div class="video-stat-label">ã„ã„ã­</div>
        </div>
        <div>
          <div class="video-stat-number">${video.comment_count || 0}</div>
          <div class="video-stat-label">ã‚³ãƒ¡ãƒ³ãƒˆ</div>
        </div>
      </div>
      <a href="/video/${video.id}" class="btn btn-small">è©³ç´°ã‚’è¦‹ã‚‹</a>
    </div>
  `
      )
      .join("");

    videoGrid.innerHTML = videoCards;
  }

  // ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
  function updateHeaderActiveState(openId) {
    // ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
    document.querySelectorAll(".user-item").forEach((item) => {
      item.classList.remove("active");
    });

    // æŒ‡å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ ã«activeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
    const activeItem = document.querySelector(`[data-open-id="${openId}"]`);
    if (activeItem) {
      activeItem.classList.add("active");
    }
  }

  // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
  function showLoading() {
    const overlay = document.getElementById("loading-overlay");
    if (overlay) {
      overlay.style.display = "flex";
    }
  }

  function hideLoading() {
    const overlay = document.getElementById("loading-overlay");
    if (overlay) {
      overlay.style.display = "none";
    }
  }
</script>
{% endblock %}
