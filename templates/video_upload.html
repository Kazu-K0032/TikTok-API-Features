{% extends "base.html" %} {% block title %}å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰{% endblock %} {%
block extra_css %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/video-upload.css') }}"
/>
{% endblock %} {% block content %}
<div class="upload-container">
  <h1>å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h1>

  <div class="upload-notice">
    <h3>âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …</h3>
    <p><strong>æœªç›£æŸ»ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å ´åˆ:</strong></p>
    <ul>
      <li>
        TikTokã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒ<strong>ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆè¨­å®š</strong>ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
      </li>
      <li>
        TikTokã‚¢ãƒ—ãƒªã§ã€Œè¨­å®šã€â†’ã€Œãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ã€â†’ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆã€ã‚’ã€Œãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã€ã«è¨­å®šã—ã¦ãã ã•ã„
      </li>
      <li>æŠ•ç¨¿ã¯ã€Œè‡ªåˆ†ã ã‘ã€ã®è¨­å®šã§ã®ã¿å¯èƒ½ã§ã™</li>
    </ul>
  </div>

  {% if account_status %}
  <div class="account-status">
    <h3>ğŸ“Š ã‚¢ã‚«ã‚¦ãƒ³ãƒˆçŠ¶æ³</h3>
    {% if account_status.error %}
    <div class="status-error">
      <p>âŒ {{ account_status.error }}</p>
    </div>
    {% else %}
    <div class="status-info">
      {% if account_status.is_private %}
      <p>âœ… <strong>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆè¨­å®šã§ã™</strong></p>
      <p>æŠ•ç¨¿ãŒå¯èƒ½ã§ã™</p>
      {% else %}
      <p>âŒ <strong>ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆè¨­å®šã§ã¯ã‚ã‚Šã¾ã›ã‚“</strong></p>
      <p>TikTokã‚¢ãƒ—ãƒªã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆè¨­å®šã«å¤‰æ›´ã—ã¦ãã ã•ã„</p>
      {% endif %} {% if account_status.privacy_options %}
      <p><strong>åˆ©ç”¨å¯èƒ½ãªãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®š:</strong></p>
      <ul>
        {% for option in account_status.privacy_options %}
        <li>{{ option }}</li>
        {% endfor %}
      </ul>

      <p><strong>åˆ¤å®šåŸºæº–:</strong></p>
      <ul>
        <li>
          âœ… ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆ:
          <code>FOLLOWER_OF_CREATOR</code
          >ãŒå«ã¾ã‚Œã€<code>PUBLIC_TO_EVERYONE</code>ãŒå«ã¾ã‚Œãªã„
        </li>
        <li>
          âŒ ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: <code>PUBLIC_TO_EVERYONE</code>ãŒå«ã¾ã‚Œã‚‹
        </li>
      </ul>
      {% endif %}
    </div>
    {% endif %}
  </div>
  {% endif %}

  <div class="upload-card">
    <form id="upload-form" enctype="multipart/form-data">
      <div class="form-group">
        <label for="video-file">å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«</label>
        <input
          type="file"
          id="video-file"
          name="video_file"
          accept="video/*"
          required
        />
        <div class="file-info" id="file-info" style="display: none">
          <p>ãƒ•ã‚¡ã‚¤ãƒ«å: <span id="file-name"></span></p>
          <p>ã‚µã‚¤ã‚º: <span id="file-size"></span></p>
          <p>å½¢å¼: <span id="file-type"></span></p>
        </div>
      </div>

      <div class="form-group">
        <label for="video-title">ã‚­ãƒ£ãƒ—ã‚·ãƒ§ãƒ³</label>
        <textarea
          id="video-title"
          name="title"
          placeholder="å‹•ç”»ã®èª¬æ˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
          maxlength="2200"
          required
        ></textarea>
        <div class="char-count"><span id="char-count">0</span>/2200</div>
      </div>

      <div class="form-group">
        <label for="privacy-level">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®š *</label>
        <select id="privacy-level" name="privacy_level" required>
          <option value="">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®šã‚’é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="SELF_ONLY">è‡ªåˆ†ã ã‘</option>
          <option value="MUTUAL_FOLLOW_FRIENDS">ç›¸äº’ãƒ•ã‚©ãƒ­ãƒ¼</option>
          <option value="PUBLIC_TO_EVERYONE">å…¬é–‹</option>
        </select>
        <div class="form-help">
          <p>
            <strong>æ³¨æ„:</strong>
            æœªç›£æŸ»ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€Œè‡ªåˆ†ã ã‘ã€ã®è¨­å®šã§ã®ã¿æŠ•ç¨¿å¯èƒ½ã§ã™ã€‚
          </p>
          <p>å…¬é–‹æŠ•ç¨¿ã‚’è¡Œã†ã«ã¯ã€TikTokã«ã‚ˆã‚‹å¯©æŸ»ãŒå¿…è¦ã§ã™ã€‚</p>
        </div>
      </div>

      <div class="form-group">
        <label>æŠ•ç¨¿è¨­å®š</label>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input
              type="checkbox"
              id="disable-comment"
              name="disable_comment"
            />
            <span class="checkmark"></span>
            ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç„¡åŠ¹ã«ã™ã‚‹
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="disable-duet" name="disable_duet" />
            <span class="checkmark"></span>
            ãƒ‡ãƒ¥ã‚¨ãƒƒãƒˆã‚’ç„¡åŠ¹ã«ã™ã‚‹
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="disable-stitch" name="disable_stitch" />
            <span class="checkmark"></span>
            ã‚¹ãƒ†ãƒƒãƒã‚’ç„¡åŠ¹ã«ã™ã‚‹
          </label>
        </div>
        <div class="form-help">
          <p>
            ä¸Šè¨˜ã®è¨­å®šã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æœ‰åŠ¹ã«ãªã£ã¦ã„ã¾ã™ã€‚ç„¡åŠ¹ã«ã—ãŸã„å ´åˆã¯ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
          </p>
        </div>
      </div>

      <div class="form-group">
        <div class="consent-declaration">
          <label class="checkbox-label">
            <input
              type="checkbox"
              id="user-consent"
              name="user_consent"
              required
            />
            <span class="checkmark"></span>
            æŠ•ç¨¿ã™ã‚‹ã“ã¨ã§ã€TikTokã®éŸ³æ¥½ä½¿ç”¨ç¢ºèªã«åŒæ„ã—ã¾ã™
          </label>
        </div>
      </div>

      <div class="form-actions">
        <button type="submit" id="upload-btn" class="btn btn-primary">
          <span class="btn-icon">ğŸ“¤</span>
          <span class="btn-text">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
        </button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
          <span class="btn-icon">â†</span>
          <span class="btn-text">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
        </a>
      </div>
    </form>
  </div>

  <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é€²æ— -->
  <div id="upload-progress" class="upload-progress" style="display: none">
    <div class="progress-header">
      <h3>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</h3>
      <div class="progress-status" id="progress-status">åˆæœŸåŒ–ä¸­...</div>
    </div>
    <div class="progress-bar">
      <div class="progress-fill" id="progress-fill"></div>
    </div>
    <div class="progress-text" id="progress-text">0%</div>
  </div>

  <!-- çµæœè¡¨ç¤º -->
  <div id="upload-result" class="upload-result" style="display: none">
    <div class="result-icon" id="result-icon">âœ…</div>
    <h3 id="result-title">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†</h3>
    <p id="result-message">å‹•ç”»ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚</p>
    <div class="result-actions">
      <a href="{{ url_for('dashboard') }}" class="btn btn-primary"
        >ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a
      >
      <button id="upload-another" class="btn btn-secondary">
        åˆ¥ã®å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      </button>
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("upload-form");
    const fileInput = document.getElementById("video-file");
    const titleInput = document.getElementById("video-title");
    const charCount = document.getElementById("char-count");
    const fileInfo = document.getElementById("file-info");
    const progressDiv = document.getElementById("upload-progress");
    const resultDiv = document.getElementById("upload-result");

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
    fileInput.addEventListener("change", function (e) {
      const file = e.target.files[0];
      if (file) {
        document.getElementById("file-name").textContent = file.name;
        document.getElementById("file-size").textContent = formatFileSize(
          file.size
        );
        document.getElementById("file-type").textContent = file.type;
        fileInfo.style.display = "block";
      } else {
        fileInfo.style.display = "none";
      }
    });

    // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
    titleInput.addEventListener("input", function () {
      const count = this.value.length;
      charCount.textContent = count;
      if (count > 2000) {
        charCount.style.color = "#ff4444";
      } else if (count > 1800) {
        charCount.style.color = "#ffaa00";
      } else {
        charCount.style.color = "#666";
      }
    });

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    form.addEventListener("submit", function (e) {
      e.preventDefault();

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const privacyLevel = document.getElementById("privacy-level").value;
      const userConsent = document.getElementById("user-consent").checked;

      if (!privacyLevel) {
        alert("ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼è¨­å®šã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      if (!userConsent) {
        alert("TikTokã®éŸ³æ¥½ä½¿ç”¨ç¢ºèªã«åŒæ„ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      const formData = new FormData(form);
      const uploadBtn = document.getElementById("upload-btn");

      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      uploadBtn.disabled = true;
      uploadBtn.innerHTML =
        '<span class="btn-icon">â³</span><span class="btn-text">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</span>';

      // é€²æ—è¡¨ç¤º
      progressDiv.style.display = "block";
      form.style.display = "none";

      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
      uploadVideo(formData);
    });

    // åˆ¥ã®å‹•ç”»ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    document
      .getElementById("upload-another")
      .addEventListener("click", function () {
        resultDiv.style.display = "none";
        form.style.display = "block";
        form.reset();
        fileInfo.style.display = "none";
        charCount.textContent = "0";
        charCount.style.color = "#666";
      });
  });

  function uploadVideo(formData) {
    const progressStatus = document.getElementById("progress-status");
    const progressFill = document.getElementById("progress-fill");
    const progressText = document.getElementById("progress-text");

    fetch("/api/upload-video", {
      method: "POST",
      body: formData,
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          showResult(true, "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†", data.message);
        } else {
          let errorMessage = data.error;
          if (errorMessage.includes("Content Posting API")) {
            errorMessage =
              "Content Posting APIã®æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚ã‚¢ãƒ—ãƒªã®è¨­å®šã§Content Posting APIã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚";
          } else if (errorMessage.includes("æœªç›£æŸ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ")) {
            errorMessage =
              "æœªç›£æŸ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿ã«æŠ•ç¨¿ã§ãã¾ã™ã€‚TikTokã‚¢ãƒ—ãƒªã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆè¨­å®šã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚";
          }
          showResult(false, "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—", errorMessage);
        }
      })
      .catch((error) => {
        console.error("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", error);
        showResult(
          false,
          "ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—",
          "ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
        );
      });
  }

  function showResult(success, title, message) {
    const progressDiv = document.getElementById("upload-progress");
    const resultDiv = document.getElementById("upload-result");
    const resultIcon = document.getElementById("result-icon");
    const resultTitle = document.getElementById("result-title");
    const resultMessage = document.getElementById("result-message");

    progressDiv.style.display = "none";
    resultDiv.style.display = "block";

    if (success) {
      resultIcon.textContent = "âœ…";
      resultIcon.style.color = "#4CAF50";
    } else {
      resultIcon.textContent = "âŒ";
      resultIcon.style.color = "#f44336";
    }

    resultTitle.textContent = title;
    resultMessage.textContent = message;
  }

  function formatFileSize(bytes) {
    if (bytes === 0) return "0 Bytes";
    const k = 1024;
    const sizes = ["Bytes", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
  }
</script>
{% endblock %}
